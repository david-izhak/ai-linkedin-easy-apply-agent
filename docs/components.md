# Описание компонентов и модулей

Этот раздел содержит детальное описание каждого ключевого модуля проекта, его назначения и основных функций.

## `core/` - Ядро проекта

Директория `core/` содержит сквозные компоненты, которые используются во всем приложении. Они обеспечивают базовую функциональность, такую как работа с базой данных, логирование, сбор метрик и управление устойчивостью.

### `database.py`

- **Назначение:** Модуль инкапсулирует все взаимодействия с базой данных SQLite (`jobs.db`). Он отвечает за создание таблиц, а также за операции чтения, записи, обновления и удаления (CRUD).
- **Ключевые функции:**
    - `setup_database()`: Создает таблицы `vacancies` и `run_history`, если они не существуют.
    - `save_discovered_jobs()`: Сохраняет новые вакансии, найденные на фазе `Discovery`.
    - `get_discovered_jobs()`: Извлекает вакансии со статусом `discovered` для фазы `Enrichment`.
    - `update_job_details()`: Обновляет запись о вакансии полной информацией после фазы `Enrichment`.
    - `get_enriched_jobs()`: Извлекает вакансии со статусом `enriched` для фазы `Processing`.
    - `update_job_status()`: Обновляет статус вакансии (`applied`, `skipped_filter` и т.д.).

### `selectors.py`

- **Назначение:** Этот файл централизует все CSS-селекторы, используемые `Playwright` для поиска элементов на страницах LinkedIn.
- **Преимущества:**
    - **Отделение логики от представления:** Логика скрейпинга и автоматизации в `actions/` и `apply_form/` не содержит "захардкоженных" селекторов.
    - **Легкость обновления:** Если LinkedIn меняет свой UI, для адаптации бота достаточно обновить селекторы только в этом файле, не трогая основную логику.

### `logger.py`

- **Назначение:** Настраивает глобальный структурированный логгер для всего приложения с использованием `structlog`.
- **Функциональность:**
    - Устанавливает уровень логирования в соответствии с параметром `LOG_LEVEL` из `config.py`.
    - Поддерживает структурированное логирование в JSON-формате с временными метками, контекстом и трейсингом.
    - Направляет вывод логов в консоль и файл (опционально).
    - Интегрируется с `core.metrics` для сбора метрик.

### `metrics.py`

- **Назначение:** Модуль для сбора метрик производительности и статистики выполнения операций.
- **Функциональность:**
    - Сбор метрик времени выполнения операций (таймеры).
    - Подсчёт событий и ошибок (счётчики).
    - Агрегация статистики по операциям.
    - Экспорт метрик для мониторинга.

### `resilience.py`

- **Назначение:** Модуль для обеспечения устойчивости операций с использованием retry-логики и circuit breakers.
- **Функциональность:**
    - **Retry-логика** (`tenacity`): Автоматические повторные попытки при временных ошибках (таймауты, сетевые проблемы).
    - **Circuit Breakers** (`pybreaker`): Предотвращение каскадных сбоев путём временного отключения неработающих зависимостей.
    - Настраиваемые стратегии повторов (экспоненциальная задержка, jitter).
    - Graceful degradation: Переход на резервные механизмы при сбоях.

### `utils.py`

- **Назначение:** Содержит различные вспомогательные функции, которые могут быть переиспользованы в разных частях проекта.
- **Примеры функций:**
    - `wait()`: Создает случайные задержки между действиями, чтобы имитировать поведение человека и снизить риск блокировки.
    - `wait_for_selector_parallel()`: Параллельное ожидание нескольких селекторов с таймаутом.
    - `wait_for_selector_with_event()`: Event-driven ожидание селектора для оптимизации производительности.
    - Функции для форматирования строк, работы с датами и т.д.

## `actions/` - Атомарные действия

Эта директория содержит модули, которые выполняют конкретные, изолированные действия в браузере.

### `login.py`

- **Назначение:** Управляет процессом входа в аккаунт LinkedIn.
- **Логика:**
    1.  Открывает страницу входа.
    2.  Вводит email и пароль из `config.py`.
    3.  Нажимает кнопку "Sign in".
    4.  Обрабатывает возможные сценарии, такие как CAPTCHA или двухфакторная аутентификация (2FA), ожидая ручного ввода от пользователя.

### `fetch_jobs.py`

- **Назначение:** Реализует логику поиска и сбора информации о вакансиях.
- **Логика:**
    1.  Формирует URL для поиска на основе `KEYWORDS`, `LOCATION` и других параметров из `config.py`.
    2.  Прокручивает страницу с результатами поиска, чтобы загрузить все доступные вакансии.
    3.  Собирает ссылки на вакансии "Easy Apply".
    4.  Для каждой вакансии может открывать ее страницу для сбора детальной информации (описание, компания и т.д.).

### `apply.py`

- **Назначение:** Оркестрирует процесс подачи заявки на одну конкретную вакансию.
- **Логика:**
    1.  Переходит на страницу вакансии.
    2.  Нажимает кнопку "Easy Apply".
    3.  Вызывает `apply_form.fill_fields.run()` для заполнения всех полей в многошаговой форме.
    4.  В зависимости от режима (`SUBMIT` или dry run) нажимает финальную кнопку "Submit application".

## `phases/` - Фазы работы бота

Модули в этой директории реализуют основную бизнес-логику, разделенную на три этапа.

- **`discovery.py`:** Запускает фазу `Discovery`. Вызывает `actions.fetch_jobs.fetch_job_links()` и сохраняет результат в БД с помощью `core.database.save_discovered_jobs()`.
- **`enrichment.py`:** Запускает фазу `Enrichment`. Получает "обнаруженные" вакансии из БД, для каждой из них вызывает `actions.fetch_jobs.fetch_job_details()` и обновляет запись в БД.
- **`processing.py`:** Реализует самую сложную фазу — `Processing`.
    - Получает "обогащенные" вакансии из БД.
    - Для каждой вакансии вызывает `_is_job_suitable()`, которая делегирует проверку `llm.vacancy_filter.is_vacancy_suitable()`.
    - При сбое LLM-фильтрации выполняет резервную проверку по ключевым словам.
    - Для подходящих вакансий вызывает `llm.cover_letter_generator.generate_cover_letter()` и `actions.apply.apply_to_job()`.

## `apply_form/` - Заполнение форм

Этот пакет отвечает за сложную логику взаимодействия с формами "Easy Apply".

- **`fill_fields.py`:** Главный модуль-оркестратор. Он итерируется по полям на странице и вызывает соответствующий специализированный обработчик для каждого типа поля.
- **Специализированные модули (`fill_text_fields.py`, `fill_boolean.py` и т.д.):** Каждый из этих файлов содержит логику для работы с конкретным типом элемента формы (текстовые поля, чекбоксы, выпадающие списки и т.д.), используя данные из `config.py`.

## `modal_flow/` - Система правил для модальных окон

Директория `modal_flow/` содержит систему правил для автоматического заполнения полей в модальных окнах LinkedIn Easy Apply.

### `rules_engine.py`

- **Назначение:** Основной движок для принятия решений о заполнении полей форм.
- **Логика:**
    1. Поиск правила в `RuleStore`
    2. Применение эвристик, если правило не найдено
    3. Делегирование к LLM, если эвристики не подходят
    4. Автоматическая генерация правил на основе решений LLM

### `rules_store.py`

- **Назначение:** Хранение и управление правилами для заполнения полей.
- **Функциональность:**
    - Поиск правил по сигнатуре поля
    - Добавление новых правил (вручную или автоматически)
    - Проверка дубликатов правил
    - Сохранение правил в YAML/JSON файл

### `llm_delegate.py` и `llm_delegate_openai.py`

- **Назначение:** Абстракция для работы с LLM при принятии решений и генерации правил.
- **Ключевые компоненты:**
    - `BaseLLMDelegate`: Абстрактный базовый класс
    - `OpenAILLMDelegate`: Реализация для OpenAI
    - `LLMDecision`: Модель решения LLM (decision, value, confidence)
    - `RuleSuggestion`: Модель предложения правила (q_pattern, strategy, confidence)

### `learning_config.py`

- **Назначение:** Конфигурация автоматического обучения системы.
- **Параметры:**
    - `enabled`: Включить/выключить автоматическое обучение
    - `auto_learn`: Автоматически сохранять правила
    - `use_separate_rule_generation`: Использовать отдельный запрос для генерации правил
    - `rule_generation_fallback`: Использовать fallback на suggest_rule из решения
    - `confidence_threshold`: Минимальная уверенность для принятия правила

### `rule_validator.py`

- **Назначение:** Валидация правил перед сохранением.
- **Проверки:**
    - Синтаксис regex паттернов
    - Структура стратегий
    - Длина паттернов
    - Наличие известных стратегий

### `modal_flow.py`

- **Назначение:** Главный оркестратор для обработки модальных окон.
- **Функциональность:**
    - Парсинг модальных окон
    - Заполнение полей через `RulesEngine`
    - Управление навигацией между шагами
    - Обработка загрузки документов

### `strategies/`

- **Назначение:** Реализации стратегий для заполнения полей.
- **Типы стратегий:**
    - `literal`: Фиксированное значение
    - `profile_key`: Значение из профиля кандидата
    - `numeric_from_profile`: Числовое значение из профиля
    - `one_of_options`: Выбор из доступных опций
    - `one_of_options_from_profile`: Выбор на основе профиля
    - `salary_by_currency`: Зарплата с учетом валюты

### Автоматическая генерация правил

Система поддерживает автоматическую генерацию правил через отдельный запрос к LLM:

1. После принятия решения LLM генерирует правило через `generate_rule()`
2. Правило валидируется через `RuleSuggestionValidator`
3. Если правило валидно и уверенность достаточна, оно сохраняется в `RuleStore`
4. В будущем правило используется автоматически, без обращения к LLM

Подробнее см. [Документация по генерации правил](modal-flow-rule-generation.md).

---

## Дополнительная информация

- [Архитектура проекта](architecture.md)
- [Схема базы данных](database-schema.md)
- [LLM интеграция](llm-integration.md)
- [Генерация правил для Modal Flow](modal-flow-rule-generation.md)
- [Руководство по началу работы](getting-started.md)
- [Оптимизация производительности](performance-optimization.md)