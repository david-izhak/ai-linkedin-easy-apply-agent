# Описание компонентов и модулей

Этот раздел содержит детальное описание каждого ключевого модуля проекта, его назначения и основных функций.

## `core/` - Ядро проекта

Директория `core/` содержит сквозные компоненты, которые используются во всем приложении. Они обеспечивают базовую функциональность, такую как работа с базой данных, логирование, сбор метрик и управление устойчивостью.

### `database.py`

- **Назначение:** Модуль инкапсулирует все взаимодействия с базой данных SQLite (`jobs.db`). Он отвечает за создание таблиц, а также за операции чтения, записи, обновления и удаления (CRUD).
- **Ключевые функции:**
    - `setup_database()`: Создает таблицы `vacancies` и `run_history`, если они не существуют.
    - `save_discovered_jobs()`: Сохраняет новые вакансии, найденные на фазе `Discovery`.
    - `get_discovered_jobs()`: Извлекает вакансии со статусом `discovered` для фазы `Enrichment`.
    - `update_job_details()`: Обновляет запись о вакансии полной информацией после фазы `Enrichment`.
    - `get_enriched_jobs()`: Извлекает вакансии со статусом `enriched` для фазы `Processing`.
    - `update_job_status()`: Обновляет статус вакансии (`applied`, `skipped_filter` и т.д.).

### `selectors.py`

- **Назначение:** Этот файл централизует все CSS-селекторы, используемые `Playwright` для поиска элементов на страницах LinkedIn.
- **Преимущества:**
    - **Отделение логики от представления:** Логика скрейпинга и автоматизации в `actions/` и `apply_form/` не содержит "захардкоженных" селекторов.
    - **Легкость обновления:** Если LinkedIn меняет свой UI, для адаптации бота достаточно обновить селекторы только в этом файле, не трогая основную логику.

### `logger.py`

- **Назначение:** Настраивает глобальный структурированный логгер для всего приложения с использованием `structlog`.
- **Функциональность:**
    - Устанавливает уровень логирования в соответствии с параметром `LOG_LEVEL` из `config.py`.
    - Поддерживает структурированное логирование в JSON-формате с временными метками, контекстом и трейсингом.
    - Направляет вывод логов в консоль и файл (опционально).
    - Интегрируется с `core.metrics` для сбора метрик.

### `metrics.py`

- **Назначение:** Модуль для сбора метрик производительности и статистики выполнения операций.
- **Функциональность:**
    - Сбор метрик времени выполнения операций (таймеры).
    - Подсчёт событий и ошибок (счётчики).
    - Агрегация статистики по операциям.
    - Экспорт метрик для мониторинга.

### `resilience.py`

- **Назначение:** Модуль для обеспечения устойчивости операций с использованием retry-логики и circuit breakers.
- **Функциональность:**
    - **Retry-логика** (`tenacity`): Автоматические повторные попытки при временных ошибках (таймауты, сетевые проблемы).
    - **Circuit Breakers** (`pybreaker`): Предотвращение каскадных сбоев путём временного отключения неработающих зависимостей.
    - Настраиваемые стратегии повторов (экспоненциальная задержка, jitter).
    - Graceful degradation: Переход на резервные механизмы при сбоях.

### `utils.py`

- **Назначение:** Содержит различные вспомогательные функции, которые могут быть переиспользованы в разных частях проекта.
- **Примеры функций:**
    - `wait()`: Создает случайные задержки между действиями, чтобы имитировать поведение человека и снизить риск блокировки.
    - `wait_for_selector_parallel()`: Параллельное ожидание нескольких селекторов с таймаутом.
    - `wait_for_selector_with_event()`: Event-driven ожидание селектора для оптимизации производительности.
    - Функции для форматирования строк, работы с датами и т.д.

## `actions/` - Атомарные действия

Эта директория содержит модули, которые выполняют конкретные, изолированные действия в браузере.

### `login.py`

- **Назначение:** Управляет процессом входа в аккаунт LinkedIn.
- **Логика:**
    1.  Открывает страницу входа.
    2.  Вводит email и пароль из `config.py`.
    3.  Нажимает кнопку "Sign in".
    4.  Обрабатывает возможные сценарии, такие как CAPTCHA или двухфакторная аутентификация (2FA), ожидая ручного ввода от пользователя.

### `fetch_jobs.py`

- **Назначение:** Реализует логику поиска и сбора информации о вакансиях.
- **Логика:**
    1.  Формирует URL для поиска на основе `KEYWORDS`, `LOCATION` и других параметров из `config.py`.
    2.  Прокручивает страницу с результатами поиска, чтобы загрузить все доступные вакансии.
    3.  Собирает ссылки на вакансии "Easy Apply".
    4.  Для каждой вакансии может открывать ее страницу для сбора детальной информации (описание, компания и т.д.).

### `apply.py`

- **Назначение:** Оркестрирует процесс подачи заявки на одну конкретную вакансию.
- **Логика:**
    1.  Переходит на страницу вакансии.
    2.  Нажимает кнопку "Easy Apply".
    3.  Вызывает `apply_form.fill_fields.run()` для заполнения всех полей в многошаговой форме.
    4.  В зависимости от режима (`SUBMIT` или dry run) нажимает финальную кнопку "Submit application".

## `phases/` - Фазы работы бота

Модули в этой директории реализуют основную бизнес-логику, разделенную на три этапа.

- **`discovery.py`:** Запускает фазу `Discovery`. Вызывает `actions.fetch_jobs.fetch_job_links()` и сохраняет результат в БД с помощью `core.database.save_discovered_jobs()`.
- **`enrichment.py`:** Запускает фазу `Enrichment`. Получает "обнаруженные" вакансии из БД, для каждой из них вызывает `actions.fetch_jobs.fetch_job_details()` и обновляет запись в БД.
- **`processing.py`:** Реализует самую сложную фазу — `Processing`.
    - Получает "обогащенные" вакансии из БД.
    - Для каждой вакансии вызывает `_is_job_suitable()`, которая делегирует проверку `llm.vacancy_filter.is_vacancy_suitable()`.
    - При сбое LLM-фильтрации выполняет резервную проверку по ключевым словам.
    - Для подходящих вакансий вызывает `llm.cover_letter_generator.generate_cover_letter()` и `actions.apply.apply_to_job()`.

## `apply_form/` - Заполнение форм

Этот пакет отвечает за сложную логику взаимодействия с формами "Easy Apply".

- **`fill_fields.py`:** Главный модуль-оркестратор. Он итерируется по полям на странице и вызывает соответствующий специализированный обработчик для каждого типа поля.
- **Специализированные модули (`fill_text_fields.py`, `fill_boolean.py` и т.д.):** Каждый из этих файлов содержит логику для работы с конкретным типом элемента формы (текстовые поля, чекбоксы, выпадающие списки и т.д.), используя данные из `config.py`.

---

## Дополнительная информация

- [Архитектура проекта](architecture.md)
- [Схема базы данных](database-schema.md)
- [LLM интеграция](llm-integration.md)
- [Руководство по началу работы](getting-started.md)
- [Оптимизация производительности](performance-optimization.md)